<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>夏田墨计算机笔记 – 计算机笔记</title><link>https://javioustlj.github.io/cs-note/</link><description>Recent content in 计算机笔记 on 夏田墨计算机笔记</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="https://javioustlj.github.io/cs-note/index.xml" rel="self" type="application/rss+xml"/><item><title>Blog: cpp类内存布局</title><link>https://javioustlj.github.io/cs-note/blog/2024/04/16/cpp%E7%B1%BB%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/</link><pubDate>Tue, 16 Apr 2024 00:00:00 +0000</pubDate><guid>https://javioustlj.github.io/cs-note/blog/2024/04/16/cpp%E7%B1%BB%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/</guid><description>
&lt;h2 id="没有虚函数的情况">没有虚函数的情况&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">class&lt;/span> &lt;span style="color:#000">A&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">public&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#000">c&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;A::A()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">func2&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">func2&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;A::func2()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">private&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">c&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">main&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span> &lt;span style="color:#000">a1&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span> &lt;span style="color:#000">a2&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>   
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>GNU gdb &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Ubuntu 12.1-0ubuntu1~22.04&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 12.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copyright &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>C&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">2022&lt;/span> Free Software Foundation, Inc.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>License GPLv3+: GNU GPL version &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span> or later &amp;lt;http://gnu.org/licenses/gpl.html&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This is free software: you are free to change and redistribute it.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>There is NO WARRANTY, to the extent permitted by law.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Type &lt;span style="color:#4e9a06">&amp;#34;show copying&amp;#34;&lt;/span> and &lt;span style="color:#4e9a06">&amp;#34;show warranty&amp;#34;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> details.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This GDB was configured as &lt;span style="color:#4e9a06">&amp;#34;x86_64-linux-gnu&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Type &lt;span style="color:#4e9a06">&amp;#34;show configuration&amp;#34;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> configuration details.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>For bug reporting instructions, please see:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;https://www.gnu.org/software/gdb/bugs/&amp;gt;.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Find the GDB manual and other documentation resources online at:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;http://www.gnu.org/software/gdb/documentation/&amp;gt;.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>For help, &lt;span style="color:#204a87">type&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;help&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Type &lt;span style="color:#4e9a06">&amp;#34;apropos word&amp;#34;&lt;/span> to search &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> commands related to &lt;span style="color:#4e9a06">&amp;#34;word&amp;#34;&lt;/span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Reading symbols from ./a.out...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> b &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Breakpoint &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> at 0x11fc: file basic.cpp, line 22.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Starting program: /mnt/work/cs-note-src/src/cpp/memory/a.out
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Thread debugging using libthread_db enabled&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Using host libthread_db library &lt;span style="color:#4e9a06">&amp;#34;/lib/x86_64-linux-gnu/libthread_db.so.1&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Breakpoint 1, main &lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> at basic.cpp:22
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> 0&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> info vtbl a1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This object does not have a virtual &lt;span style="color:#204a87;font-weight:bold">function&lt;/span> table
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This object does not have a virtual &lt;span style="color:#204a87;font-weight:bold">function&lt;/span> table
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p a
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$1&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">i&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>0, 1045149306&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>, &lt;span style="color:#000">x&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 1.2904777690891933e-08, &lt;span style="color:#000">d&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 1.2904777690891933e-08&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p a1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$2&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">c&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p a2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$3&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">c&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>a1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$4&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>A *&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 0x7fffffffe250
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>a2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$5&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>A *&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 0x7fffffffe254
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>a1&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>could not find typeinfo symbol &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;A&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> info address A::func2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Symbol &lt;span style="color:#4e9a06">&amp;#34;A::func2()&amp;#34;&lt;/span> is a &lt;span style="color:#204a87;font-weight:bold">function&lt;/span> at address 0x5555555552da.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> info symbo A::func2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> in section .text of /mnt/work/cs-note-src/src/cpp/memory/a.out
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="存在虚函数的情况">存在虚函数的情况&lt;/h2>
&lt;pre tabindex="0">&lt;code>
```sh
GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
Copyright (C) 2022 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &amp;lt;http://gnu.org/licenses/gpl.html&amp;gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type &amp;#34;show copying&amp;#34; and &amp;#34;show warranty&amp;#34; for details.
This GDB was configured as &amp;#34;x86_64-linux-gnu&amp;#34;.
Type &amp;#34;show configuration&amp;#34; for configuration details.
For bug reporting instructions, please see:
&amp;lt;https://www.gnu.org/software/gdb/bugs/&amp;gt;.
Find the GDB manual and other documentation resources online at:
&amp;lt;http://www.gnu.org/software/gdb/documentation/&amp;gt;.
For help, type &amp;#34;help&amp;#34;.
Type &amp;#34;apropos word&amp;#34; to search for commands related to &amp;#34;word&amp;#34;...
Reading symbols from ./virtual...
(gdb) b 24
Breakpoint 1 at 0x11fc: file virtual.cpp, line 24.
(gdb) run
Starting program: /mnt/work/cs-note-src/src/cpp/memory/virtual
[Thread debugging using libthread_db enabled]
Using host libthread_db library &amp;#34;/lib/x86_64-linux-gnu/libthread_db.so.1&amp;#34;.
A::A()
A::func2()
A::A()
A::func2()
Breakpoint 1, main () at virtual.cpp:24
24 return 0;
(gdb) p a1
$1 = {_vptr.A = 0x555555557d68 &amp;lt;vtable for A+16&amp;gt;, c = 0}
(gdb) p &amp;amp;a1
$2 = (A *) 0x7fffffffe230
(gdb) x /2xg 0x7fffffffe230
0x7fffffffe230: 0x0000555555557d68 0x0000000000000000
(gdb) info vtbl a1
vtable for &amp;#39;A&amp;#39; @ 0x555555557d68 (subobject @ 0x7fffffffe230):
[0]: 0x5555555552ea &amp;lt;A::virtual_func1()&amp;gt;
[1]: 0x555555555366 &amp;lt;A::virtual_func3()&amp;gt;
(gdb) p typeid(a1)
$3 = {_vptr.type_info = 0x7ffff7fa2fa0 &amp;lt;vtable for __cxxabiv1::__class_type_info+16&amp;gt;, __name = 0x55555555603c &amp;lt;typeinfo name for A&amp;gt; &amp;#34;1A&amp;#34;}
(gdb) p sizeof(typeid(a1))
$4 = 16
(gdb) p &amp;amp;typeid(a1)
$5 = (gdb_gnu_v3_type_info *) 0x555555557d78 &amp;lt;typeinfo for A&amp;gt;
(gdb) x /4xg 0x555555557d68
0x555555557d68 &amp;lt;_ZTV1A+16&amp;gt;: 0x00005555555552ea 0x0000555555555366
0x555555557d78 &amp;lt;_ZTI1A&amp;gt;: 0x00007ffff7fa2fa0 0x000055555555603c
0x555555557d88: 0x0000000000000001 0x0000000000000169
0x555555557d98: 0x0000000000000001 0x0000000000000178
&lt;/code>&lt;/pre>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>0x555555557d80 0x000055555555603c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d78 0x00007ffff7fa2fa0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d70 0x0000555555555366
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d68 0x00005555555552ea
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="虚函数继承">虚函数继承&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">class&lt;/span> &lt;span style="color:#000">A&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">public&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#000">c&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;A::A()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">func2&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">virtual&lt;/span> &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">virtual_func1&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;A::virtual_func1()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">func2&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;A::func2()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">virtual&lt;/span> &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">virtual_func3&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;A::virtual_func3()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">private&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">c&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">class&lt;/span> &lt;span style="color:#000">B&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#204a87;font-weight:bold">public&lt;/span> &lt;span style="color:#000">A&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">public&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">B&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">),&lt;/span> &lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;B::B()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">func2&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">B&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">),&lt;/span> &lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;B::B(int a, int b)&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">func2&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#ce5c00;font-weight:bold">~&lt;/span>&lt;span style="color:#000">B&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;B::~B()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">virtual&lt;/span> &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">virtual_fun1&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;B::virtual_fun1()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">func2&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;B::func2()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">virtual&lt;/span> &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">virtual_func3&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;B::virtual_func3()&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">private&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">main&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span> &lt;span style="color:#000">a1&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span> &lt;span style="color:#000">a2&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">B&lt;/span> &lt;span style="color:#000">b1&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">B&lt;/span> &lt;span style="color:#000">b2&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> b &lt;span style="color:#0000cf;font-weight:bold">48&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Breakpoint &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> at 0x1235: file ./inheritance.cpp, line 48.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Starting program: /mnt/work/cs-note-src/src/cpp/memory/inheritance
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Thread debugging using libthread_db enabled&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Using host libthread_db library &lt;span style="color:#4e9a06">&amp;#34;/lib/x86_64-linux-gnu/libthread_db.so.1&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::B&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::B&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::func2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Breakpoint 1, main &lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> at ./inheritance.cpp:48
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">48&lt;/span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> 0&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p b1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$1&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&amp;lt;A&amp;gt; &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>_vptr.A &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0x555555557d10 &amp;lt;vtable &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> B+16&amp;gt;, &lt;span style="color:#000">c&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>, &lt;span style="color:#000">a&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0, &lt;span style="color:#000">b&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p b2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$2&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&amp;lt;A&amp;gt; &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>_vptr.A &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0x555555557d10 &amp;lt;vtable &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> B+16&amp;gt;, &lt;span style="color:#000">c&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>, &lt;span style="color:#000">a&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0, &lt;span style="color:#000">b&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>b1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$3&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>B *&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 0x7fffffffe210
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>b2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$4&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>B *&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 0x7fffffffe230
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>b1&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$5&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>_vptr.type_info &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0x7ffff7fa3c30 &amp;lt;vtable &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> __cxxabiv1::__si_class_type_info+16&amp;gt;, &lt;span style="color:#000">__name&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0x55555555607b &amp;lt;typeinfo name &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> B&amp;gt; &lt;span style="color:#4e9a06">&amp;#34;1B&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>b2&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$6&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>_vptr.type_info &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0x7ffff7fa3c30 &amp;lt;vtable &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> __cxxabiv1::__si_class_type_info+16&amp;gt;, &lt;span style="color:#000">__name&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 0x55555555607b &amp;lt;typeinfo name &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> B&amp;gt; &lt;span style="color:#4e9a06">&amp;#34;1B&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> info vtbr b1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Undefined info command: &lt;span style="color:#4e9a06">&amp;#34;vtbr b1&amp;#34;&lt;/span>. Try &lt;span style="color:#4e9a06">&amp;#34;help info&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> info vtbl b1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vtable &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;B&amp;#39;&lt;/span> @ 0x555555557d10 &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>subobject @ 0x7fffffffe210&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>0&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>: 0x555555555362 &amp;lt;A::virtual_func1&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>1&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>: 0x55555555555e &amp;lt;B::virtual_func3&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>2&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>: 0x5555555554e2 &amp;lt;B::virtual_fun1&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> p &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>b1&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">$7&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb_gnu_v3_type_info *&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 0x555555557d48 &amp;lt;typeinfo &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> B&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> x /16xg 0x555555557d10
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d10 &amp;lt;_ZTV1B+16&amp;gt;: 0x0000555555555362 0x000055555555555e
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d20 &amp;lt;_ZTV1B+32&amp;gt;: 0x00005555555554e2 0x0000000000000000
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d30 &amp;lt;_ZTV1A+8&amp;gt;: 0x0000555555557d60 0x0000555555555362
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d40 &amp;lt;_ZTV1A+24&amp;gt;: 0x00005555555553de 0x00007ffff7fa3c30
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d50 &amp;lt;_ZTI1B+8&amp;gt;: 0x000055555555607b 0x0000555555557d60
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d60 &amp;lt;_ZTI1A&amp;gt;: 0x00007ffff7fa2fa0 0x000055555555607e
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d70: 0x0000000000000001 0x00000000000001b6
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d80: 0x0000000000000001 0x00000000000001c5
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>0x555555557d68 0x000055555555607e --&amp;gt; typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>a&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#000">__name&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 1A
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d60 0x00007ffff7fa2fa0 --&amp;gt; typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>a&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> _vptr.type_info
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d58 0x0000555555557d60
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d50 0x000055555555607b --&amp;gt; typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>b&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#000">__name&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> 1B
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d48 0x00007ffff7fa3c30 --&amp;gt; typeid&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>b&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> _vptr.type_info
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d40 0x00005555555553de --&amp;gt; A::virtual_func3&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d38 0x0000555555555362 --&amp;gt; A::virtual_func1&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d30 0x0000555555557d60
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d28 0x0000000000000000
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d20 0x00005555555554e2 --&amp;gt; B::virtual_fun1&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d18 0x000055555555555e --&amp;gt; B::virtual_func3&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>0x555555557d10 0x0000555555555362 --&amp;gt; A::virtual_func1&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Blog: gdb常用命令总结</title><link>https://javioustlj.github.io/cs-note/blog/2024/04/05/gdb%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</link><pubDate>Fri, 05 Apr 2024 00:00:00 +0000</pubDate><guid>https://javioustlj.github.io/cs-note/blog/2024/04/05/gdb%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/</guid><description>
&lt;h2 id="1-cheat-sheet">1. cheat sheet&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">显示类命令&lt;/th>
&lt;th>缩写&lt;/th>
&lt;th>命令说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">info&lt;/td>
&lt;td>i&lt;/td>
&lt;td>查看断点 / 线程等信息&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">print&lt;/td>
&lt;td>p&lt;/td>
&lt;td>打印变量或寄存器值&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">display&lt;/td>
&lt;td>display&lt;/td>
&lt;td>自动显示命令&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">whatis&lt;/td>
&lt;td>whatis&lt;/td>
&lt;td>查看变量类型&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ptype&lt;/td>
&lt;td>ptype&lt;/td>
&lt;td>查看变量类型&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">list&lt;/td>
&lt;td>l&lt;/td>
&lt;td>显示源码&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">disassemble&lt;/td>
&lt;td>dis&lt;/td>
&lt;td>查看汇编代码&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">backtrace&lt;/td>
&lt;td>bt&lt;/td>
&lt;td>查看当前线程的调用堆栈&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">help&lt;/td>
&lt;td>help&lt;/td>
&lt;td>帮助命令&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>控制类型的命令&lt;/th>
&lt;th>缩写&lt;/th>
&lt;th>命令说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>run&lt;/td>
&lt;td>r&lt;/td>
&lt;td>运行一个待调试的程序&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>continue&lt;/td>
&lt;td>c&lt;/td>
&lt;td>让暂停的程序继续运行&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>next&lt;/td>
&lt;td>n&lt;/td>
&lt;td>运行到下一行&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>step&lt;/td>
&lt;td>s&lt;/td>
&lt;td>单步执行，遇到函数会进入&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>until&lt;/td>
&lt;td>u&lt;/td>
&lt;td>运行到指定行停下来&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>finish&lt;/td>
&lt;td>fi&lt;/td>
&lt;td>结束当前调用函数，回到上一层调用函数处&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>return&lt;/td>
&lt;td>return&lt;/td>
&lt;td>结束当前调用函数并返回指定值，到上一层函数调用处&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>jump&lt;/td>
&lt;td>j&lt;/td>
&lt;td>将当前程序执行流跳转到指定行或地址&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>断点监视点&lt;/th>
&lt;th>缩写&lt;/th>
&lt;th>命令说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>break&lt;/td>
&lt;td>b&lt;/td>
&lt;td>添加断点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>tbreak&lt;/td>
&lt;td>tb&lt;/td>
&lt;td>添加临时断点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>delete&lt;/td>
&lt;td>d&lt;/td>
&lt;td>删除断点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>enable&lt;/td>
&lt;td>enable&lt;/td>
&lt;td>启用某个断点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>disable&lt;/td>
&lt;td>disable&lt;/td>
&lt;td>禁用某个断点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>watch&lt;/td>
&lt;td>watch&lt;/td>
&lt;td>监视某一个变量或内存地址的值是否发生变化&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>名称&lt;/th>
&lt;th>缩写&lt;/th>
&lt;th>命令说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>frame&lt;/td>
&lt;td>f&lt;/td>
&lt;td>切换到当前调用线程的指定堆栈&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>thread&lt;/td>
&lt;td>thread&lt;/td>
&lt;td>切换到指定线程&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>set args&lt;/td>
&lt;td>set args&lt;/td>
&lt;td>设置程序启动命令行参数&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>show args&lt;/td>
&lt;td>show args&lt;/td>
&lt;td>查看设置的命令行参数&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="11-常用调试方式">1.1 常用调试方式&lt;/h3>
&lt;ol>
&lt;li>直接调试目标程序：&lt;/li>
&lt;li>附加进程 id：gdb attach pid&lt;/li>
&lt;li>调试 core 文件：gdb filename corename&lt;/li>
&lt;/ol>
&lt;p>调试目标程序&lt;/p>
&lt;pre tabindex="0">&lt;code>gdb ./hello_world
&lt;/code>&lt;/pre>&lt;p>调试一个正在运行的程序&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 启动时直接attach到一个进程&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gdb -p PID
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 在gdb环境中 attach一个进程&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>（gdb） attach PID
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>调试 core 文件：&lt;/p>
&lt;pre tabindex="0">&lt;code>gdb ./program_name corename
&lt;/code>&lt;/pre>&lt;h3 id="12-常用命令">1.2 常用命令&lt;/h3>
&lt;p>退出命令：&lt;strong>q（quit）或者 Ctr + d&lt;/strong>
启动程序：&lt;strong>r (run)&lt;/strong>
继续运行：&lt;strong>c (continue）&lt;/strong>
查看调用栈：&lt;strong>bt (backtrace）&lt;/strong>
进入调用栈：&lt;strong>f （frame）堆栈编号&lt;/strong>
单步执行：&lt;strong>n（next）&lt;/strong>，遇到函数直接跳过，不进入函数内部
单步执行：&lt;strong>s（step）&lt;/strong>，会进入函数内部
退出当前函数：&lt;strong>finish&lt;/strong>，继续执行完当前函数，正常退出
返回当前函数：&lt;strong>return&lt;/strong>，从当前位置，从当前函数退出，剩下的代码不执行了，可以指定函数的返回值；
指定位置停下来：&lt;strong>until&lt;/strong>，和 &lt;strong>break&lt;/strong> 类似
查看某段代码的汇编指令：&lt;strong>disassemble&lt;/strong>
帮助命令：&lt;strong>help&lt;/strong>&lt;/p>
&lt;h3 id="13-断点">1.3 断点&lt;/h3>
&lt;h4 id="131-设置断点">1.3.1 设置断点&lt;/h4>
&lt;p>程序运行到某一行&lt;/p>
&lt;pre tabindex="0">&lt;code>b test.cpp 100
&lt;/code>&lt;/pre>&lt;p>程序运行到某一个函数&lt;/p>
&lt;pre tabindex="0">&lt;code>b namespace::func
&lt;/code>&lt;/pre>&lt;p>其他文件设置&lt;/p>
&lt;pre tabindex="0">&lt;code>b a.cpp:441
&lt;/code>&lt;/pre>&lt;p>其他文件的某一个函数&lt;/p>
&lt;pre tabindex="0">&lt;code>b a.cpp:func
&lt;/code>&lt;/pre>&lt;p>设置条件断点&lt;/p>
&lt;pre tabindex="0">&lt;code>b if i = 8
&lt;/code>&lt;/pre>&lt;h4 id="132-查看断点">1.3.2 查看断点&lt;/h4>
&lt;pre tabindex="0">&lt;code>info b
&lt;/code>&lt;/pre>&lt;h4 id="133-删除断点">1.3.3 删除断点&lt;/h4>
&lt;p>删除第几个断点&lt;/p>
&lt;pre tabindex="0">&lt;code>delete N
&lt;/code>&lt;/pre>&lt;p>删除第几行的断点&lt;/p>
&lt;pre tabindex="0">&lt;code>clear N
&lt;/code>&lt;/pre>&lt;h4 id="134使能断点">1.3.4使能断点&lt;/h4>
&lt;p>使能第 N 个断点&lt;/p>
&lt;pre tabindex="0">&lt;code>enable N
&lt;/code>&lt;/pre>&lt;p>不使能第 N 个断点&lt;/p>
&lt;pre tabindex="0">&lt;code>disable N
&lt;/code>&lt;/pre>&lt;h3 id="14-监视点">1.4 监视点&lt;/h3>
&lt;p>单个变量&lt;/p>
&lt;pre tabindex="0">&lt;code>watch i
&lt;/code>&lt;/pre>&lt;p>指针变量，监视的是指针变量本身，&lt;/p>
&lt;pre tabindex="0">&lt;code>watch p
&lt;/code>&lt;/pre>&lt;p>指针所指向的变量，监视指针所值的内容：&lt;/p>
&lt;pre tabindex="0">&lt;code>watch *p
&lt;/code>&lt;/pre>&lt;p>数组，可以监视整个数组的内容&lt;/p>
&lt;pre tabindex="0">&lt;code>watch a
&lt;/code>&lt;/pre>&lt;p>注意：当监视的变量变化时会自动停下来
当监视的变量脱离了作用域，也就失效了；&lt;/p>
&lt;h3 id="15-打印">1.5 打印&lt;/h3>
&lt;p>调用函数&lt;/p>
&lt;pre tabindex="0">&lt;code>p func()
&lt;/code>&lt;/pre>&lt;p>调试过程中修改变量的值&lt;/p>
&lt;pre tabindex="0">&lt;code>print var=value
&lt;/code>&lt;/pre>&lt;p>计算表达式并打印&lt;/p>
&lt;pre tabindex="0">&lt;code>print a+b+c
&lt;/code>&lt;/pre>&lt;p>输出当前对象的各成员变量的值&lt;/p>
&lt;pre tabindex="0">&lt;code>print *this
&lt;/code>&lt;/pre>&lt;p>查看变量类型&lt;/p>
&lt;pre tabindex="0">&lt;code>whatis var
&lt;/code>&lt;/pre>&lt;p>查看变量类型，可以查看复合数据类型，会打印出该类型的成员变量&lt;/p>
&lt;pre tabindex="0">&lt;code>ptype val
&lt;/code>&lt;/pre>&lt;h4 id="151-打印字符串">1.5.1 打印字符串&lt;/h4>
&lt;p>打印 &lt;code>std::string&lt;/code>&lt;/p>
&lt;p>打印内容&lt;/p>
&lt;pre tabindex="0">&lt;code>p str
p str.c_str()
&lt;/code>&lt;/pre>&lt;p>打印长度&lt;/p>
&lt;pre tabindex="0">&lt;code>p str.length()
p str.size()
&lt;/code>&lt;/pre>&lt;p>字符串太长&lt;/p>
&lt;pre tabindex="0">&lt;code>set print elements 0
&lt;/code>&lt;/pre>&lt;h4 id="152-打印-vector-和-map">1.5.2 打印 vector 和 map&lt;/h4>
&lt;h3 id="16-list-命令">1.6 &lt;code>list&lt;/code> 命令&lt;/h3>
&lt;p>输出上一次list命令显示的代码后面的代码，如果是第一次执行list命令，则会显示当前正在执行代码位置附近的代码；&lt;/p>
&lt;pre tabindex="0">&lt;code>list
&lt;/code>&lt;/pre>&lt;p>上一次 list 命令显示的代码前面的代码&lt;/p>
&lt;pre tabindex="0">&lt;code>list -
&lt;/code>&lt;/pre>&lt;p>显示当前代码文件第 &lt;strong>Linenumber&lt;/strong> 行附近的代码；&lt;/p>
&lt;pre tabindex="0">&lt;code>list Linenumber
&lt;/code>&lt;/pre>&lt;p>显示 &lt;strong>FileName&lt;/strong> 文件第 &lt;strong>LineNo&lt;/strong> 行附近的代码&lt;/p>
&lt;pre tabindex="0">&lt;code>list FileName:Linenumber
&lt;/code>&lt;/pre>&lt;p>显示当前文件的 &lt;strong>FunctionName&lt;/strong> 函数附近的代码&lt;/p>
&lt;pre tabindex="0">&lt;code>list FunctionName
&lt;/code>&lt;/pre>&lt;p>显示 &lt;strong>FileName&lt;/strong> 文件的 &lt;strong>FunctionName&lt;/strong> 函数附件的代码&lt;/p>
&lt;pre tabindex="0">&lt;code>list FileName:FunctionName
&lt;/code>&lt;/pre>&lt;p>其中&lt;strong>from&lt;/strong>和&lt;strong>to&lt;/strong>是具体的代码位置，显示这之间的代码&lt;/p>
&lt;pre tabindex="0">&lt;code>list from,to
&lt;/code>&lt;/pre>&lt;h3 id="17-jump-命令">1.7 &lt;code>jump&lt;/code> 命令&lt;/h3>
&lt;ol>
&lt;li>中间跳过的代码是不会执行的；&lt;/li>
&lt;li>跳到的位置后如果没有断点，那么GDB会自动继续往后执行；&lt;/li>
&lt;/ol>
&lt;p>跳转到第几行&lt;/p>
&lt;pre tabindex="0">&lt;code>jump line_number
&lt;/code>&lt;/pre>&lt;p>跳转往下 10行&lt;/p>
&lt;pre tabindex="0">&lt;code>jump + 10
&lt;/code>&lt;/pre>&lt;p>跳转到具体的内存地址&lt;/p>
&lt;pre tabindex="0">&lt;code>jump *0X12345678
&lt;/code>&lt;/pre>&lt;h3 id="18-display-命令">1.8 display 命令&lt;/h3>
&lt;p>基本用法&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>display expression
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>
&lt;p>&lt;strong>跟踪变量值：&lt;/strong> 如果您正在调试一个C程序，并且想观察变量&lt;code>foo&lt;/code>的值随程序执行的变化，可以这样设置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> display foo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>显示内存地址内容：&lt;/strong> 若要跟踪特定内存地址（如&lt;code>0x12345678&lt;/code>）的内容：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> display *0x12345678
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>跟踪表达式结果：&lt;/strong> 如果您关心的是某个计算结果或复杂表达式的值，比如变量&lt;code>a&lt;/code>与&lt;code>b&lt;/code>之和：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> display a + b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>格式化输出：&lt;/strong> 可以使用&lt;code>/fmt&lt;/code>选项来指定显示值的格式，类似于&lt;code>printf&lt;/code>函数的格式化字符串。例如，以十六进制显示整数：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> display/x foo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>或以浮点数的科学记数法显示：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> display/g foo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看GDB文档或使用&lt;code>help format&lt;/code>命令获取更多关于格式化选项的信息。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>查看已设置的display项：&lt;/strong> 如果您设置了多个&lt;code>display&lt;/code>命令，可以使用&lt;code>info display&lt;/code>命令列出所有当前生效的自动显示项及其编号：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> info display
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>取消自动显示：&lt;/strong> 要取消之前设置的某个&lt;code>display&lt;/code>项，使用&lt;code>undisplay&lt;/code>命令并指定其编号：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> undisplay &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上述命令将取消编号为1的&lt;code>display&lt;/code>设置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>临时禁用所有自动显示：&lt;/strong> 如果想暂时关闭所有自动显示，而不取消它们的设置，可以使用&lt;code>disable display&lt;/code>命令：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> disable display
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>后续可以通过&lt;code>enable display&lt;/code>命令重新启用所有自动显示。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>查看即将执行的汇编指令：&lt;/strong> 在调试汇编程序时，使用&lt;code>display/i $pc&lt;/code>命令可以显示每次程序暂停时即将执行的汇编指令：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> display/i &lt;span style="color:#000">$pc&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>$pc&lt;/code>是GDB的内部变量，代表当前程序计数器的值，即下一条要执行的指令地址。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="2-调试分析-core-文件">2 调试分析 core 文件&lt;/h2>
&lt;ol>
&lt;li>用 gdb 打开 core 文件&lt;/li>
&lt;li>查看堆栈信息&lt;/li>
&lt;li>进入某个栈：f N，f 是 frame 的缩写，N 是栈号，如0、1、2、3&amp;hellip;&lt;/li>
&lt;li>进入栈之后，查看变量，print&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>gdb ./program core
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>bt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>where
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>f &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="3-多线程调试">3 多线程调试&lt;/h2>
&lt;h3 id="31-常用的命令">3.1 常用的命令&lt;/h3>
&lt;p>查看所有线程信息&lt;/p>
&lt;pre tabindex="0">&lt;code>info thread
&lt;/code>&lt;/pre>&lt;p>切换线程&lt;/p>
&lt;pre tabindex="0">&lt;code>thread thread_number
&lt;/code>&lt;/pre>&lt;p>查看所有线程的栈信息&lt;/p>
&lt;pre tabindex="0">&lt;code>thread apply all bt
&lt;/code>&lt;/pre>&lt;p>在特定线程编号上打断点&lt;/p>
&lt;pre tabindex="0">&lt;code>break location thread thread_number
&lt;/code>&lt;/pre>&lt;p>通用的命令, 可以用 all，作用禹全部线程&lt;/p>
&lt;pre tabindex="0">&lt;code>thread apply thread_number1 thread_number2 ... command
&lt;/code>&lt;/pre>&lt;h3 id="32-模式">3.2 模式&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>all-stop mode&lt;/strong>，全停模式，当程序由于任何原因在 GDB 下停止时，不止当前的线程停止，所有的执行线程都停止。这样允许你检查程序的整体状态，包括线程切换，不用担心当下会有什么改变。&lt;/li>
&lt;li>&lt;strong>non-stop mode&lt;/strong>，不停模式，调试器（如VS2008和老版本的GDB）往往只支持 &lt;strong>all-stop&lt;/strong> 模式，但在某些场景中，我们可能需要调试个别的线程，并且不想在调试过程中影响其他线程的运行，这样可以把GDB的调式模式由 &lt;strong>all-stop&lt;/strong> 改成 &lt;strong>non-stop&lt;/strong>，&lt;strong>7.0&lt;/strong> 版本的GDB引入了 &lt;strong>non-stop&lt;/strong> 模式。在 &lt;strong>non-stop&lt;/strong> 模式下 &lt;strong>continue、next、step&lt;/strong> 命令只针对当前线程。&lt;/li>
&lt;li>&lt;strong>record mode&lt;/strong>，记录模式；记录模式允许 GDB 记录程序的执行过程，包括线程的运行、变量的修改等，并将这些信息保存到记录文件中。这个功能可以帮助您分析程序的运行过程，并且可以在之后的时间点回放这些记录，从而帮助您定位问题或理解程序的执行流程。&lt;/li>
&lt;li>&lt;strong>replay mode&lt;/strong>，回放模式；回放模式允许您回放之前记录的执行过程。在这个模式下，您可以重现程序之前的执行状态，以便更深入地分析和调试程序。这种模式在查找程序运行中的难以复现的问题时非常有用。&lt;/li>
&lt;/ul>
&lt;p>non-stop 模式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>gdb -exec-run-mode non-stop your_program
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>记录模式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>gdb -record record_file_name your_program
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>回放模式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>gdb -replay record_file_name
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="33-设置线程锁">3.3 设置线程锁&lt;/h3>
&lt;p>默认的调试模式：&lt;strong>一个线程暂停运行，其他线程也随即暂停；一个线程启动运行，其他线程也随即启动&lt;/strong>&lt;/p>
&lt;p>但在一些场景中，我们希望只让特定线程运行，其他线程都维持在暂停状态，即要防止&lt;strong>线程切换&lt;/strong>。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>set scheduler-locking on&lt;/strong>，锁定线程，只有当前或指定线程可以运行；专注于一个调试一个线程。&lt;/li>
&lt;li>&lt;strong>set scheduler-locking off&lt;/strong>，在单步调试当前线程时，其他线程不受影响，继续并发执行。&lt;/li>
&lt;li>&lt;strong>set scheduler-locking step&lt;/strong>，当单步执行某一线程时，其他线程不会执行，同时保证在调试过程中当前线程不会发生改变。但如果在该模式下执行 &lt;strong>continue、until、finish&lt;/strong> 命令，则其他线程也会执行；&lt;/li>
&lt;li>&lt;strong>show scheduler-locking&lt;/strong>，查看线程锁定状态；&lt;/li>
&lt;/ul>
&lt;h2 id="4-技巧">4 技巧&lt;/h2>
&lt;p>和 shell 一样，有一些简便操作：&lt;/p>
&lt;ol>
&lt;li>上下方向键可以查看最近的命令&lt;/li>
&lt;li>回车，执行上一次执行的命令，单步调试非常有用&lt;/li>
&lt;/ol>
&lt;p>Reference:&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/297925056">https://zhuanlan.zhihu.com/p/297925056&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.zhihu.com/question/65306462">https://www.zhihu.com/question/65306462&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Blog: 一个奇怪问题的debug之旅</title><link>https://javioustlj.github.io/cs-note/blog/2024/04/05/%E4%B8%80%E4%B8%AA%E5%A5%87%E6%80%AA%E9%97%AE%E9%A2%98%E7%9A%84debug%E4%B9%8B%E6%97%85/</link><pubDate>Fri, 05 Apr 2024 00:00:00 +0000</pubDate><guid>https://javioustlj.github.io/cs-note/blog/2024/04/05/%E4%B8%80%E4%B8%AA%E5%A5%87%E6%80%AA%E9%97%AE%E9%A2%98%E7%9A%84debug%E4%B9%8B%E6%97%85/</guid><description>
&lt;h2 id="问题">问题&lt;/h2>
&lt;p>公司的守护进程的优雅关闭，是通过捕获 &lt;code>SIGTERM&lt;/code> 实现的：&lt;/p>
&lt;ol>
&lt;li>捕获 &lt;code>SIGTERM&lt;/code>&lt;/li>
&lt;li>退出处理（释放资源等等）&lt;/li>
&lt;li>最后调用 &lt;code>pthread_exit&lt;/code> 退出&lt;/li>
&lt;/ol>
&lt;p>出现的问题是：优雅关闭时，进程又收到了 &lt;code>SIGABRT&lt;/code> ，导致进程又被异常杀死了，最后进程并没有优雅的关闭。&lt;/p>
&lt;p>当然在公司定位这个问题的过程中，都是通过日志和 gdb 工具来进行的。&lt;/p>
&lt;p>现在我们模拟一下解决这个问题的过程，为了方便起见，就使用打印和 gdb 来进行debug&lt;/p>
&lt;p>模拟的问题代码如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;pthread.h&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;signal.h&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">printSigInfo&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">signo&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">siginfo_t&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">void&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Signal Info:&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;  si_signo: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_signo&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34; - Signal number&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;  si_code: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_code&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34; - Signal code&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;  si_errno: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_errno&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34; - Errno value associated with signal&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_code&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;gt;&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_code&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&lt;/span> &lt;span style="color:#000">NSIG&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#8f5902;font-style:italic">// 可能需要针对具体情况进行检查
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;  si_pid: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_pid&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34; - Sending process ID&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;  si_uid: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_uid&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34; - Real user ID of sending process&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_addr&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;  si_addr: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">static_cast&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&amp;gt;&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">info&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">-&amp;gt;&lt;/span>&lt;span style="color:#000">si_addr&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34; - Faulting address&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">LinuxSigHandler&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">signo&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">siginfo_t&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">void&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">switch&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">signo&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#204a87;font-weight:bold">case&lt;/span> &lt;span style="color:#f57900">SIGABRT&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught signal SIGABRT (&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">signo&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;).&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#000">printSigInfo&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">signo&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#204a87;font-weight:bold">break&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#204a87;font-weight:bold">case&lt;/span> &lt;span style="color:#f57900">SIGTERM&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught signal SIGTERM (&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">signo&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;).&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#000">printSigInfo&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">signo&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">info&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>          &lt;span style="color:#000">pthread_exit&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#204a87;font-weight:bold">break&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#204a87;font-weight:bold">default&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught signal &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">signo&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>            &lt;span style="color:#204a87;font-weight:bold">break&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#8f5902;font-style:italic">// 重新引发信号
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>    &lt;span style="color:#000">raise&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">signo&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">InitSignalHandlers&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_handler&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_sigaction&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#000">LinuxSigHandler&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigemptyset&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_mask&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_flags&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">typeof&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_flags&lt;/span>&lt;span style="color:#000;font-weight:bold">))(&lt;/span>&lt;span style="color:#000">SA_RESTART&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">|&lt;/span> &lt;span style="color:#000">SA_SIGINFO&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">|&lt;/span> &lt;span style="color:#000">SA_RESETHAND&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">SIGSEGV&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">SIGILL&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">SIGFPE&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">SIGBUS&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">SIGABRT&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">SIGTERM&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#8f5902;font-style:italic">/* Ignored signals. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000">action_ignore&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">action_ignore&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_handler&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#000">SIG_IGN&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">action_ignore&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_flags&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigemptyset&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action_ignore&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">sa_mask&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">sigaction&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">SIGPIPE&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">action_ignore&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">NULL&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">main_thread&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#000;font-weight:bold">(;;)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;main_thread is running:&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">sleep&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">10&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">main&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">InitSignalHandlers&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">try&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">main_thread&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span> &lt;span style="color:#204a87;font-weight:bold">catch&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">exception&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span> &lt;span style="color:#000">e&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cerr&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught exception: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">e&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">what&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">catch&lt;/span> &lt;span style="color:#000;font-weight:bold">(...)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cerr&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught unknown exception&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cerr&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;process close&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们先来观察一段这段代码，它有如下特点：&lt;/p>
&lt;ol>
&lt;li>它是一个守护进程，死循环在处理业务逻辑&lt;/li>
&lt;li>它调用了 &lt;code>sigaction&lt;/code> 函数修改了与指定信号的相关联的处理动作
&lt;ol>
&lt;li>注意 &lt;code>SIGTERM&lt;/code>： 收到这个信号，做打印并调用了 &lt;code>pthread_exit&lt;/code>&lt;/li>
&lt;li>&lt;code>SIGABRT&lt;/code>: 收到这个信号，做打印；&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>当收到 &lt;code>SIGTERM&lt;/code> 时，它应该有打印，并优雅的退出，不应该再有其他的打印。&lt;/li>
&lt;/ol>
&lt;p>我们如何测试呢？&lt;/p>
&lt;ol>
&lt;li>我们测试这个程序现在用 &lt;code>kill -SIGTERM&lt;/code> 实现。公司的系统优雅的关闭就是通过 &lt;code>systemd&lt;/code> 发送 &lt;code>SIGTERM&lt;/code> 实现的。&lt;/li>
&lt;/ol>
&lt;p>现在我们来做一个测试吧！&lt;/p>
&lt;p>我们来以这段代码做个测试，编译这段代码得到可执行文件 &lt;code>abi&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>g++ abi.cpp -o abi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在窗口 1 运行它&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>./abi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>main_thread is running:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>main_thread is running:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在窗口 2 里面执行：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>ps -ef &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep abi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tlj &lt;span style="color:#0000cf;font-weight:bold">980622&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">976483&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 08:36 pts/0 00:00:00 ./abi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ &lt;span style="color:#204a87">kill&lt;/span> -SIGTERM &lt;span style="color:#0000cf;font-weight:bold">980622&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>观察窗口 1：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>./abi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>main_thread is running:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>main_thread is running:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Caught signal SIGTERM &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>15&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Signal Info:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_signo: &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> - Signal number
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_code: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> - Signal code
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_errno: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> - Errno value associated with signal
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Caught unknown exception
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>FATAL: exception not rethrown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Caught signal SIGABRT &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>6&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Signal Info:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_signo: &lt;span style="color:#0000cf;font-weight:bold">6&lt;/span> - Signal number
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_code: -6 - Signal code
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_errno: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> - Errno value associated with signal
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Aborted &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>core dumped&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="分析">分析&lt;/h2>
&lt;p>??? 怎么又收到了一个 &lt;code>SIGABRT&lt;/code> ，还异常关闭了？&lt;/p>
&lt;p>从打印可以看到&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>Caught unknown exception
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这里捕获了一个异常，那么按照正常的逻辑，它应该继续往下执行 &lt;code>std::cerr &amp;lt;&amp;lt; &amp;quot;process close&amp;quot; &amp;lt;&amp;lt; std::endl;&lt;/code> 才对，结果它没有往下执行，到这里就收到了 &lt;code>SIGABRT&lt;/code>.&lt;/p>
&lt;p>十分怪异！&lt;/p>
&lt;p>那我们先来看一下 &lt;code>core dump&lt;/code> 看看发生了什么？&lt;/p>
&lt;p>先启用coredump&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">ulimit&lt;/span> -c unlimited
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;/var/crash/core-%e-%p-%t&amp;#34;&lt;/span> &amp;gt; /proc/sys/kernel/core_pattern
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>用 gdb 看一下 core 的情况：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>root@ubuntu:/mnt/work/cs-note-src/src/cpp/debug# gdb ./abi core_abi_2262_1712044154
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>GNU gdb &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Ubuntu 12.1-0ubuntu1~22.04&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 12.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copyright &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>C&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">2022&lt;/span> Free Software Foundation, Inc.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>License GPLv3+: GNU GPL version &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span> or later &amp;lt;http://gnu.org/licenses/gpl.html&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This is free software: you are free to change and redistribute it.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>There is NO WARRANTY, to the extent permitted by law.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Type &lt;span style="color:#4e9a06">&amp;#34;show copying&amp;#34;&lt;/span> and &lt;span style="color:#4e9a06">&amp;#34;show warranty&amp;#34;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> details.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This GDB was configured as &lt;span style="color:#4e9a06">&amp;#34;x86_64-linux-gnu&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Type &lt;span style="color:#4e9a06">&amp;#34;show configuration&amp;#34;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> configuration details.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>For bug reporting instructions, please see:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;https://www.gnu.org/software/gdb/bugs/&amp;gt;.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Find the GDB manual and other documentation resources online at:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;http://www.gnu.org/software/gdb/documentation/&amp;gt;.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>For help, &lt;span style="color:#204a87">type&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;help&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Type &lt;span style="color:#4e9a06">&amp;#34;apropos word&amp;#34;&lt;/span> to search &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> commands related to &lt;span style="color:#4e9a06">&amp;#34;word&amp;#34;&lt;/span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Reading symbols from ./abi...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>New LWP 2262&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Thread debugging using libthread_db enabled&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Using host libthread_db library &lt;span style="color:#4e9a06">&amp;#34;/lib/x86_64-linux-gnu/libthread_db.so.1&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Core was generated by &lt;span style="color:#4e9a06">`&lt;/span>./abi&lt;span style="color:#a40000">&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Program terminated with signal SIGABRT, Aborted.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#0 __pthread_kill_implementation (no_tid=0, signo=6, threadid=139802159551424) at ./nptl/pthread_kill.c:44&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">44&lt;/span> ./nptl/pthread_kill.c: No such file or directory.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> bt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#0 __pthread_kill_implementation (no_tid=0, signo=6, threadid=139802159551424) at ./nptl/pthread_kill.c:44&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#1 __pthread_kill_internal (signo=6, threadid=139802159551424) at ./nptl/pthread_kill.c:78&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#2 __GI___pthread_kill (threadid=139802159551424, signo=signo@entry=6) at ./nptl/pthread_kill.c:89&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#3 0x00007f263a21b476 in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#4 0x00007f263a2017f3 in __GI_abort () at ./stdlib/abort.c:79&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#5 0x00007f263a2623dc in __libc_message (action=do_abort, fmt=0x7f263a3b479c &amp;#34;%s&amp;#34;, fmt=0x7f263a3b479c &amp;#34;%s&amp;#34;, action=do_abort)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> at ../sysdeps/posix/libc_fatal.c:155
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#6 0x00007f263a2626f0 in __GI___libc_fatal (message=&amp;lt;optimized out&amp;gt;) at ../sysdeps/posix/libc_fatal.c:164&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#7 0x00007f263a2763f6 in unwind_cleanup (reason=&amp;lt;optimized out&amp;gt;, exc=&amp;lt;optimized out&amp;gt;) at ./nptl/unwind.c:114&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#8 0x0000562cea54094f in main () at new_abi.cpp:85&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>gdb&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>从这里看出来似乎就是从 main 函数发生了错误，剩下的调用栈都是库函数了。&lt;/p>
&lt;p>到这里就没有思路了，main 哪里写的有问题？&lt;/p>
&lt;p>在 &lt;code>catch(...)&lt;/code> 的时候出错了，我们去掉，重新测试，还真没有了异常！&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>root@ubuntu:/mnt/work/cs-note-src/src/cpp/debug# ./abi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>main_thread is running:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Caught signal SIGTERM &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>15&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Signal Info:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_signo: &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> - Signal number
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_code: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> - Signal code
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_errno: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> - Errno value associated with signal
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>那我们基本就知道了，是 &lt;code>catch(...)&lt;/code> 带来的这个问题。那么究竟是怎么带来的呢？&lt;/p>
&lt;p>那我们就要了解 C++ stack unwinding&lt;/p>
&lt;h3 id="stack-unwinding-栈展开">Stack unwinding 栈展开&lt;/h3>
&lt;p>&lt;strong>堆栈展开&lt;/strong>是在运行时从函数调用堆栈中删除函数条目的过程。局部对象以与构建它们的相反顺序被销毁。&lt;/p>
&lt;p>堆栈展开通常与&lt;a href="https://www.geeksforgeeks.org/exception-handling-c/">异常处理&lt;/a>有关。在 C++ 中，当发生异常时，将线性搜索函数调用堆栈以查找异常处理程序，并且从函数调用堆栈中删除具有异常处理程序的函数之前的所有条目。因此，如果在同一函数（抛出异常的位置）中未处理异常，则异常处理涉及堆栈展开。基本上，堆栈展开是为运行时构造的所有自动对象调用析构函数（每当引发异常时）的过程。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;string&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">#include&lt;/span> &lt;span style="color:#8f5902;font-style:italic">&amp;lt;memory&amp;gt;&lt;/span>&lt;span style="color:#8f5902;font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">using&lt;/span> &lt;span style="color:#204a87;font-weight:bold">namespace&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">class&lt;/span> &lt;span style="color:#000">A&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">public&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;A::A(): &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">a&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">virtual&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">~&lt;/span>&lt;span style="color:#000">A&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;A::~A(): &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">a&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">disp&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;A disp&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">private&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">class&lt;/span> &lt;span style="color:#000">B&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#204a87;font-weight:bold">public&lt;/span> &lt;span style="color:#000">A&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">public&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">B&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000">string&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#000">A&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">),&lt;/span> &lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;B::B(): &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">b&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#ce5c00;font-weight:bold">~&lt;/span>&lt;span style="color:#000">B&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;B::~B(): &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">b&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">disp&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;B disp&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">private&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">a&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">string&lt;/span> &lt;span style="color:#000">b&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">f1&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;f1() Start &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">B&lt;/span> &lt;span style="color:#000">b1&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;stack object&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">A&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">P&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">new&lt;/span> &lt;span style="color:#000">B&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">2&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;heap object&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">shared_ptr&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&lt;/span>&lt;span style="color:#000">A&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;gt;&lt;/span> &lt;span style="color:#000">p2&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#000">make_shared&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&lt;/span>&lt;span style="color:#000">B&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;gt;&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;shared ptr object&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">throw&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;f1() End &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">f2&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;f2() Start &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">f1&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;f2() End &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">void&lt;/span> &lt;span style="color:#000">f3&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;f3() Start &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">try&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">f2&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">catch&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught Exception: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">cout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;f3() End&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">main&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">f3&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>f3&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> Start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>f2&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> Start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>f1&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> Start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::B&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: stack object
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::B&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: heap object
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::B&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: shared ptr object
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::~B&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: shared ptr object
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::~A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>B::~B&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: stack object
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>A::~A&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Caught Exception: &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>f3&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> End
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>当异常发生的时候，如果没有异常处理程序，这些局部变量一个一个去销毁的。需要注意的是 &lt;code>p2&lt;/code> ，当异常发生时，没有发生析构，这说明，这里会有&lt;strong>资源泄露&lt;/strong>，所以当在实际项目中，需要注意到这一点。&lt;/p>
&lt;p>现在我们知道了异常处理的过程，那么我们的测试程序究竟捕获了什么异常呢？为什么又导致了 &lt;code>SIGABRT&lt;/code> 呢？&lt;/p>
&lt;p>从调用栈，我们看到 &lt;code>main&lt;/code> 函数调用的是 &lt;code>nptl/unwind.c&lt;/code> 中的 &lt;code>unwind_cleanup&lt;/code> 函数，咱们先看看这个函数到底是怎么回事？&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// https://github.com/lattera/glibc/blob/master/nptl/unwind.c
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">static&lt;/span> &lt;span style="color:#204a87;font-weight:bold">void&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">unwind_cleanup&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">_Unwind_Reason_Code&lt;/span> &lt;span style="color:#000">reason&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000">_Unwind_Exception&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">exc&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8f5902;font-style:italic">/* When we get here a C++ catch block didn&amp;#39;t rethrow the object. We
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"> cannot handle this case and therefore abort. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">__libc_fatal&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;FATAL: exception not rethrown&lt;/span>&lt;span style="color:#4e9a06">\n&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>看这里的注释&lt;/p>
&lt;blockquote>
&lt;p>“当程序运行到这里，那就是 C++ catch 块没有重新抛出对象。我们无法处理这种情况，所以触发 abort”&lt;/p>
&lt;/blockquote>
&lt;p>那么就可以明白了，我们 catch 了一个异常，但是没有重新抛出，所以 glibc 出发了 abort。&lt;/p>
&lt;p>那么我们 catch 的这个异常到底是什么呢？从我们的程序可以看出，我们只是调用了 &lt;code>pthread_exit&lt;/code>, &lt;code>pthread&lt;/code> 本身是应该只是 C 库，并不是 C++库，它不应该抛出异常啊。&lt;/p>
&lt;p>这和 &lt;code>glibc&lt;/code> 和 &lt;code>gcc&lt;/code> 的实现相关！&lt;/p>
&lt;p>&lt;code>pthread_exit&lt;/code> 或者 &lt;code>pthread_cancel&lt;/code> 都会抛出一个 &lt;code>___forced_unwind&lt;/code> 异常，用于在线程退出期间展开堆栈 (stack unwinding). 当程序捕获了这个异常，需要务必重新抛出它，以便系统可以做完整的 &lt;code>stack unwinding&lt;/code>。&lt;/p>
&lt;p>如果捕获了这个异常，那么栈展开就没办法继续进行下去了，所以 glibc 就会调用系统调用 abort 函数来进行 &lt;code>SIGABRT&lt;/code> 异常处理。&lt;/p>
&lt;h2 id="修改-并测试">修改 并测试&lt;/h2>
&lt;p>知道了真正原因，那么修改我们原有的程序，让它优雅的关闭吧&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">main&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">InitSignalHandlers&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">try&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">main_thread&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span> &lt;span style="color:#204a87;font-weight:bold">catch&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">exception&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span> &lt;span style="color:#000">e&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cerr&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught exception: &amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">e&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">what&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">catch&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">abi&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">_forced_unwind&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cerr&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught forced_unwid error and retrow it&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">throw&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">catch&lt;/span> &lt;span style="color:#000;font-weight:bold">(...)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>        &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cerr&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Caught unknown exception&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">cerr&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;process close&amp;#34;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#000">std&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">::&lt;/span>&lt;span style="color:#000">endl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>    &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>测试一下，成功了，程序可以优雅关闭了！&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>main_thread is running:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>main_thread is running:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Caught signal SIGTERM &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>15&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Signal Info:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_signo: &lt;span style="color:#0000cf;font-weight:bold">15&lt;/span> - Signal number
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_code: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> - Signal code
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> si_errno: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> - Errno value associated with signal
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Caught forced_unwid error and retrow it
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="总结">总结:&lt;/h2>
&lt;ol>
&lt;li>异常处理程序，要千万注意资源泄露；&lt;/li>
&lt;li>异常处理程序的 stack unwinding 的过程是怎么样的。&lt;/li>
&lt;li>通过 gdb 和 core dump 来进行 debug。&lt;/li>
&lt;/ol>
&lt;p>Reference:&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://stackoverflow.com/questions/11452546/why-does-pthread-exit-throw-something-caught-by-ellipsis">https://stackoverflow.com/questions/11452546/why-does-pthread-exit-throw-something-caught-by-ellipsis&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cxx-abi-dev.codesourcery.narkive.com/VlHf6T8W/gcc-unwind-abi-change-for-forced-unwind">https://cxx-abi-dev.codesourcery.narkive.com/VlHf6T8W/gcc-unwind-abi-change-for-forced-unwind&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.geeksforgeeks.org/stack-unwinding-in-c/">https://www.geeksforgeeks.org/stack-unwinding-in-c/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.csdn.net/Jqivin/article/details/121908435">https://blog.csdn.net/Jqivin/article/details/121908435&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://copyprogramming.com/howto/pthread-exit-null-not-working">https://copyprogramming.com/howto/pthread-exit-null-not-working&lt;/a>&lt;/li>
&lt;/ol></description></item></channel></rss>